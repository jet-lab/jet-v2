#!/bin/bash
# CI validation script.
# Run a single job from the CI workflow:
#   ./check <job-name>
#           (wrap the job name in quotes if it has spaces)
# Run the entire workflow:
#   ./check all
# Run jobs in the container used for CI:
#   ./check in-docker '<job-name or all>'

set -euxo pipefail

DOCKER_IMAGE=jetprotocol/builder:solana-1.10.35-anchor-0.25.0-3

#################
# Workflow Jobs

anchor-test() {
    [[ "$@" == *--skip-yarn* ]] || yarn-build
    args="$(sed s/--skip-yarn//g <<< "$@")"
	anchor test $args -- --features testing
}

hosted-tests-localnet() {
    tests/scripts/on_localnet.sh anchor-build
    SOLANA_LOGS=true tests/scripts/on_localnet.sh test combined
}

cargo-lint() {
    cargo fmt --all --check
    cargo clippy --all-targets -- -Dwarnings
    cargo test --doc
}

cargo-test() {
    if [[ ${CODECOV:-false} == true ]]; then
        cargo llvm-cov --workspace --lcov --output-path lcov.info --ignore-filename-regex programs/mock-pyth/src/lib.rs
    else 
        cargo test
    fi
}

#################
# helper functions

yarn-build() {
    yarn install --frozen-lockfile
    yarn --cwd libraries/ts/margin build:with-wasm
}

# runs every workflow job. default if no args are given
all() {
    cargo-lint
    cargo-test
    hosted-tests-localnet
    anchor-test
}

# runs whatever command follows in a docker container
in-docker() {
    docker run \
        -v "$(dirname $(realpath ${BASH_SOURCE[0]})):/jet-v2" \
        --workdir /jet-v2 \
        $DOCKER_IMAGE \
        /jet-v2/check $@
}

if [[ "$@" == '' ]]; then
    all
else
    $@
fi

set +x
echo -e '\n\n âœ” all good'
