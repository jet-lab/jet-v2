#!/bin/bash
# CI validation script.
# Run a single job from the CI workflow:
#   ./check <job-name>
#           (wrap the job name in quotes if it has spaces)
# Run the entire workflow:
#   ./check all
# Run jobs in the container used for CI:
#   ./check in-docker '<job-name or all>'

set -euxo pipefail

DOCKER_IMAGE=jetprotocol/builder:root-solana1.10.35-anchor0.25.0-1

aliases=(
	localnet-tests/cargo-test-localnet
	'Typescript Integration Tests'/anchor-test
	coverage/cargo-test
)


anchor-test() {
	npm ci
	anchor test -- --features testing
}

cargo-test-localnet() {
	tests/hosted/test_on_localnet.sh
}

cargo-check() {
	cargo fmt --all --check
	cargo clippy --all-targets -- -Dwarnings
	cargo test --doc
}

cargo-test() {
	if [[ ${CODECOV:-false} == true ]]; then
		cargo llvm-cov --workspace --lcov --output-path lcov.info --ignore-filename-regex programs/mock-pyth/src/lib.rs
	else 
		cargo test
	fi
}


all() {
	cargo-check
	cargo-test
	anchor-test
	cargo-test-localnet
}

in-docker() {
	docker run \
		-v "$(dirname $(realpath ${BASH_SOURCE[0]})):/jet-v2" \
		--workdir /jet-v2 \
		$DOCKER_IMAGE \
		/jet-v2/check $@
}


cmd="$@"
for alias in "${aliases[@]}"; do
	cmd=$(sed "s/$alias/g" <<<$cmd)
done

$cmd

set +x
echo -e '\n\n âœ” all good'
